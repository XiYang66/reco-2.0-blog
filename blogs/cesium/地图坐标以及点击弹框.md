---
title: åœ°å›¾åæ ‡ä»¥åŠç‚¹å‡»å¼¹æ¡†
date: 2022-8-16
tags:
 - cesiumä¸‰ç»´åœ°å›¾
categories: 
 - cesiumä¸‰ç»´åœ°å›¾
---

## ç‚¹ä½æ˜¾ç¤º

```js
export default {
  ...
  mounted () {
    this.init()
    this.loadPoints()
  },
  // Vueæ–¹æ³•å®šä¹‰
  methods: {
    // åœ°å›¾åˆå§‹åŒ–
    init() {
      ...
    },
    // æ¨¡æ‹Ÿç‚¹ä½æ•°æ®
    loadPoints() {
      // ç”¨æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•
      this.pointInfo = [
        {
          id: '392f7fbb-ae25-4eef-ac43-58fd91148d1f',
          latitude: '31.87532',
          longitude: '120.55538',
          psName: 'æœ‰é™å…¬å¸1',
        },
        {
          id: '0278a88c-b4f4-4d64-9ccb-65831b3fb19d',
          latitude: '31.991057',
          longitude: '120.700713',
          psName: 'æœ‰é™å…¬å¸2',
        },
        {
          id: '248f6853-2ced-4aa6-b679-ea6422a5f3ac',
          latitude: '31.94181',
          longitude: '120.51517',
          psName: 'æœ‰é™å…¬å¸3',
        },
        {
          id: 'F8DADA95-A438-49E1-B263-63AE3BD7DAC4',
          latitude: '31.97416',
          longitude: '120.56132',
          psName: 'æœ‰é™å…¬å¸4',
        },
        {
          id: '9402a911-78c5-466a-9162-d5b04d0e48f0',
          latitude: '31.91604',
          longitude: '120.57771',
          psName: 'æœ‰é™å…¬å¸5',
        },
        {
          id: 'EB392DD3-6998-437F-8DCB-F805AD4DB340',
          latitude: '31.88727',
          longitude: '120.48887',
          psName: 'æœ‰é™å…¬å¸6',
        },
      ]
      this.addMarker()
    },
    // cesium åŠ è½½ç‚¹ä½
    addMarker() {
      const Cesium = this.cesium
      // æ¸…é™¤ä¸Šä¸€æ¬¡åŠ è½½çš„ç‚¹ä½
      this.viewer.entities.removeAll()
      // foreachå¾ªç¯åŠ è½½ç‚¹ä½
      this.pointInfo.forEach((pointObj) => {
        this.viewer.entities.add({
          name: pointObj.psName,
          code: pointObj.id,
          id: pointObj.id,
          position: Cesium.Cartesian3.fromDegrees(pointObj.longitude * 1, pointObj.latitude * 1),
          // ç‚¹
          // point: {
          //   pixelSize: 5,
          //   color: Cesium.Color.RED,
          //   outlineColor: Cesium.Color.WHITE,
          //   outlineWidth: 2,
          // },
          // æ–‡å­—æ ‡ç­¾
          label: {
            // show: false,
            text: pointObj.psName,  
            font: "12px monospace",
            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
            fillColor: Cesium.Color.fromCssColorString("rgb(11, 255, 244)"),
            outlineWidth: 4,
            verticalOrigin: Cesium.VerticalOrigin.BOTTOM, // å‚ç›´æ–¹å‘ä»¥åº•éƒ¨æ¥è®¡ç®—æ ‡ç­¾çš„ä½ç½®
            pixelOffset: new Cesium.Cartesian2(0, -20), // åç§»é‡
          },
           // å›¾æ ‡
          billboard: {
            image: require("@/assets/logo.png"),
            width: 18,
            height: 24,
          },
        })
      })
    },
  }
}
```

è¿™é‡Œç”¨åˆ°å•¦APIä¸­çš„[viewer](http://cesium.xin/cesium/cn/Documentation1.95/Viewer.html?classFilter=viewer)ä¸­[entities.removeAll()](http://cesium.xin/cesium/cn/Documentation1.95/EntityCollection.html)å’Œ[entities.add()](http://cesium.xin/cesium/cn/Documentation1.95/EntityCollection.html)


## ç‚¹å‡»åæ ‡å¼¹æ¡†æ˜¾ç¤º

> å¼•å…¥å¼¹æ¡†ç»„ä»¶
``` js
// åœ°å›¾ç»„ä»¶
<template>
  <div class="map-box">
    <div id="cesiumContainer"></div>
     <!-- åœ°å›¾å¼¹æ¡† -->
    <div class="dynamic-layer" id="one">
      <div class="line"></div>
      <div class="main">
        <cesiumPopup :pointInfo="popData" ref="popUp" />
        <!-- ä¸‹æ–¹ç®­å¤´ -->
          <div class="tooltip-arrow"></div>
      </div>
    </div>
  </div>
</template>
// å¼¹æ¡†ç»„ä»¶
<template>
  <div>
    æˆ‘æ˜¯å¼¹æ¡†
  </div>
</template>

<script>
export default {
  name: '',
  props:['pointInfo'],
  // Vueæ–¹æ³•å®šä¹‰
  methods: {
    defalutSetting() {},
  }
}
</script>
```
> ç”¨åˆ°å•¦jQuery éœ€è¦ `npm i jQuery` å®‰è£…æŒ‚è½½åˆ°main.jsä¸­ 
```js
import $ from 'jquery';
Vue.prototype.$ = $;
```
> ç»™åœ°å›¾ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œä½¿å¼¹æ¡†å…ƒç´ å‡ºç°
```js
init(){
  ...
  // ç»™å…¨å›¾ç»‘å®šäº‹ä»¶
  const handler = new Cesium.ScreenSpaceEventHandler(this.viewer.scene.canvas);
  handler.setInputAction((click)=>{
    // å±å¹•åæ ‡ è½¬ ä¸–ç•Œåæ ‡
    const cartesian = this.viewer.camera.pickEllipsoid(click.position,this.viewer.scene.globe.ellipsoid)
    // ä¸–ç•Œåæ ‡ è½¬ åœ°ç†åæ ‡
    const cartographic = Cesium.Cartographic.fromCartesian(cartesian)

    // ä¿ç•™5ä½æ•°ä»¥åè¿›åˆ¶æ–¹å¼æ˜¾ç¤º
    const lon = Cesium.Math.toDegrees(cartographic.longitude).toFixed(5)
    const lat = Cesium.Math.toDegrees(cartographic.latitude).toFixed(5)
    console.log("ğŸš€ ~ file: No01-init.vue ~ line 76 ~ handler.setInputAction ~ lat lon",lon,lat)
    // è·å–åœ°å›¾ä¸Šçš„ç‚¹ä½å®ä½“(entity)åæ ‡
    const pick = this.viewer.scene.pick(click.position);
    console.log("ğŸš€ ~ file: No01-init.vue ~ line 92 ~ handler.setInputAction ~ pick", pick)
    // å¦‚æœpickä¸æ˜¯undefined é‚£ä¹ˆä»–å°±æ˜¯ç‚¹ä½
    if(pick&&pick.id){
      const data = {
        layerId: "layer1", // è‹±æ–‡ï¼Œä¸”å”¯ä¸€,å†…éƒ¨entityä¼šç”¨å¾—åˆ°
        lon: lon,
        lat: lat,
        element: "#one", // å¼¹æ¡†çš„å”¯ä¸€id
        boxHeightMax: 0, // ä¸­é—´ç«‹æ–¹ä½“çš„æœ€å¤§é«˜åº¦
      };
      this.$("#one").css("z-index", 9990);
      this.showDynamicLayer(this.viewer, data, () => { // å›è°ƒå‡½æ•° æ”¹å˜å¼¹çª—çš„å†…å®¹;
        this.popData.title = pick.id.name;
        this.popData.pointId = pick.id.id;
      });
      // è°ƒç”¨å¼¹æ¡†çš„é»˜è®¤æ–¹æ³•
      this.$refs.popUp.defalutSetting();

      // ç‚¹ä½åœ°å›¾å®šä½
      this.locationToCenter(lon, lat);
    } else {
      // ç§»é™¤å¼¹æ¡†
      if (document.querySelector("#one")) {
        this.removeDynamicLayer(this.viewer, { element: "#one" });
        this.$("#one").css("z-index", -1);
      }
    }
    
  },Cesium.ScreenSpaceEventType.LEFT_CLICK)  //å‡½æ•°æ–¹æ³• å•å‡»
},
// åˆ›å»ºä¸€ä¸ªåŠ¨æ€å®ä½“å¼¹çª—
showDynamicLayer(viewer, data, callback) {
  /* å¼¹çª—çš„domæ“ä½œ--é»˜è®¤å¿…é¡»*/
  this.$(data.element).css({ opacity: 0 }); // ä½¿ç”¨hide()æˆ–è€…displayæ˜¯ä¸è¡Œçš„ å› ä¸ºcesiumæ˜¯ç”¨preå®šæ—¶é‡ç»˜çš„divå¯¼è‡´ left top display ä¼šä¸€ç›´é‡ç»˜
  this.$(".dynamic-layer .line").css({ width: 0 });
  this.$(data.element).find(".main").hide(0);
  /* å¼¹çª—çš„domæ“ä½œ--é’ˆå¯¹æ€§æ“ä½œ*/
  callback();

  // æ·»åŠ divå¼¹çª—
  const lon = data.lon * 1, lat = data.lat * 1;
  // data.boxHeightMaxä¸ºundefä¹Ÿæ²¡äº‹
  var divPosition = this.cesium.Cartesian3.fromDegrees(lon, lat, data.boxHeightMax);
  this.$("#one").css({ opacity: 1 });
  this.$("#one").find(".line").animate({
    width: 50 // çº¿çš„å®½åº¦
  }, 500, () => {
    this.$("#one").find(".main").fadeIn(500);
  });
  // å½“ä¸ºtrueçš„æ—¶å€™ï¼Œè¡¨ç¤ºå½“elementåœ¨åœ°çƒèƒŒé¢ä¼šè‡ªåŠ¨éšè—ã€‚é»˜è®¤ä¸ºfalseï¼Œç½®ä¸ºfalseï¼Œä¸ä¼šè¿™æ ·ã€‚ä½†è‡³å°‘å‡è½»åˆ¤æ–­è®¡ç®—å‹åŠ›
  this.creatHtmlElement(viewer, data.element, divPosition, [10, -0], true);
},
// åˆ›å»ºä¸€ä¸ª htmlElementå…ƒç´  å¹¶ä¸”ï¼Œå…¶åœ¨earthèƒŒåä¼šè‡ªåŠ¨éšè—
creatHtmlElement(viewer, element, position, arr, flog) {
  const Cesium = this.cesium;
  var ele = document.querySelector(element);
  var scratch = new Cesium.Cartesian2(); // cesiumäºŒç»´ç¬›å¡å°” ç¬›å¡å°”äºŒç»´åæ ‡ç³»å°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„è€ŒäºŒç»´åæ ‡ç³»ï¼›ä¸‰ç»´ä¹Ÿå¦‚æ­¤
  var scene = viewer.scene, camera = viewer.camera;
  scene.preRender.addEventListener(() => {
    var canvasPosition = scene.cartesianToCanvasCoordinates(position, scratch); // cartesianToCanvasCoordinates ç¬›å¡å°”åæ ‡ï¼ˆ3ç»´åº¦ï¼‰åˆ°ç”»å¸ƒåæ ‡
    if (Cesium.defined(canvasPosition)) {
      ele.style.left = (canvasPosition.x + arr[0] - 534/2 - 15 + 5) + 'px';
      ele.style.top = (canvasPosition.y + arr[1] - 30 - 22) + 'px';
      /* æ­¤å¤„è¿›è¡Œåˆ¤æ–­**/// var px_position = Cesium.SceneTransforms.wgs84ToWindowCoordinates(scene, cartesian)
      if (flog && flog == true) {
        var e = position, i = camera.position, n = scene.globe.ellipsoid.cartesianToCartographic(i).height
        if (!(n += 1 * scene.globe.ellipsoid.maximumRadius, Cesium.Cartesian3.distance(i, e) > n)) {
          // $(element).show()
          ele.style.display = "block";
        } else {
          ele.style.display = "none";
          // $(element).hide()
        }
      }
    }
  });
},
// ç§»é™¤åŠ¨æ€å¼¹çª— ä¸ºäº†æ–¹ä¾¿ è¿™é‡Œçš„ç§»é™¤ æ˜¯çœŸçš„ç§»é™¤ï¼Œå› æ­¤ åˆ°æ—¶æ˜¯éœ€è¦é‡å»ºå¼¹çª—çš„doomçš„
removeDynamicLayer(viewer, data) {
  document.querySelector(data.element).style.opacity = 0;
},
```


## å®šä½ä¸­å¿ƒç‚¹åœ¨åœ°å›¾ä¸­é—´

```js
init(){
  ...
  // ç»™å…¨å›¾ç»‘å®šäº‹ä»¶
  const handler = new Cesium.ScreenSpaceEventHandler(this.viewer.scene.canvas); 
  handler.setInputAction((click)=>{
    // ç‚¹ä½åœ°å›¾å®šä½
    this.locationToCenter(lon, lat);
  },Cesium.ScreenSpaceEventType.LEFT_CLICK)
  ...
},
// ç‚¹ä½å®šä½åˆ°åœ°å›¾ä¸­å¿ƒ
locationToCenter(lon, lat) {
  const Cesium = this.cesium;
  const pointLocation = new Cesium.BoundingSphere(Cesium.Cartesian3.fromDegrees(lon * 1, lat * 1, 100), 15000); // 120.55538, 31.87532
  this.viewer.camera.flyToBoundingSphere(pointLocation);
},

```
